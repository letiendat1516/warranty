<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Netflix Warranty - H·ªá th·ªëng qu·∫£n l√Ω key Netflix t·ª± ƒë·ªông</title>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 20px;
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
      }

      .header {
          text-align: center;
          color: white;
          margin-bottom: 30px;
      }

      .header h1 {
          font-size: 2.5em;
          margin-bottom: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 15px;
      }

      .header p {
          font-size: 1.1em;
          opacity: 0.9;
      }

      .card {
          background: white;
          border-radius: 15px;
          padding: 30px;
          box-shadow: 0 10px 40px rgba(0,0,0,0.2);
          margin-bottom: 20px;
      }

      .tabs {
          display: flex;
          gap: 10px;
          margin-bottom: 30px;
          border-bottom: 2px solid #e0e0e0;
      }

      .tab {
          padding: 12px 24px;
          background: none;
          border: none;
          cursor: pointer;
          font-size: 16px;
          color: #666;
          border-bottom: 3px solid transparent;
          transition: all 0.3s;
          display: flex;
          align-items: center;
          gap: 8px;
      }

      .tab:hover {
          color: #667eea;
      }

      .tab.active {
          color: #667eea;
          border-bottom-color: #667eea;
          font-weight: 600;
      }

      .tab-content {
          display: none;
      }

      .tab-content.active {
          display: block;
          animation: fadeIn 0.3s;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          color: #333;
          font-weight: 500;
      }

      .form-group input {
          width: 100%;
          padding: 12px 15px;
          border: 2px solid #e0e0e0;
          border-radius: 8px;
          font-size: 15px;
          transition: border-color 0.3s;
      }

      .form-group input:focus {
          outline: none;
          border-color: #667eea;
      }

      .btn {
          padding: 12px 30px;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          cursor: pointer;
          transition: all 0.3s;
          display: inline-flex;
          align-items: center;
          gap: 8px;
          font-weight: 500;
      }

      .btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
      }

      .btn-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
      }

      .btn-primary:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
          background: #f5f5f5;
          color: #666;
      }

      .btn-secondary:hover {
          background: #e0e0e0;
      }

      .btn-success {
          background: #10b981;
          color: white;
      }

      .btn-success:hover {
          background: #059669;
      }

      .btn-warning {
          background: #f59e0b;
          color: white;
      }

      .btn-warning:hover {
          background: #d97706;
      }

      .btn-danger {
          background: #ef4444;
          color: white;
      }

      .btn-danger:hover {
          background: #dc2626;
      }

      .alert {
          padding: 15px 20px;
          border-radius: 8px;
          margin-bottom: 20px;
          display: none;
      }

      .alert.show {
          display: block;
          animation: slideDown 0.3s;
      }

      @keyframes slideDown {
          from { opacity: 0; transform: translateY(-10px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .alert-success {
          background: #d1fae5;
          color: #065f46;
          border-left: 4px solid #10b981;
      }

      .alert-error {
          background: #fee2e2;
          color: #991b1b;
          border-left: 4px solid #ef4444;
      }

      .alert-info {
          background: #dbeafe;
          color: #1e40af;
          border-left: 4px solid #3b82f6;
      }

      .alert-warning {
          background: #fef3c7;
          color: #92400e;
          border-left: 4px solid #f59e0b;
      }

      .token-display {
          background: #f8fafc;
          border: 2px dashed #667eea;
          border-radius: 8px;
          padding: 20px;
          margin: 20px 0;
          text-align: center;
      }

      .token-value {
          font-size: 20px;
          font-weight: bold;
          color: #667eea;
          font-family: 'Courier New', monospace;
          word-break: break-all;
          margin: 10px 0;
      }

      .dashboard-stats {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          margin-bottom: 30px;
      }

      .stat-card {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
      }

      .stat-card h3 {
          font-size: 2em;
          margin-bottom: 5px;
      }

      .stat-card p {
          opacity: 0.9;
      }

      .key-list {
          display: grid;
          gap: 15px;
      }

      .key-card {
          background: #f8fafc;
          border: 2px solid #e0e0e0;
          border-radius: 10px;
          padding: 20px;
          transition: all 0.3s;
      }

      .key-card:hover {
          border-color: #667eea;
          box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
      }

      .key-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 15px;
      }

      .key-code {
          font-size: 18px;
          font-weight: bold;
          color: #667eea;
          font-family: 'Courier New', monospace;
      }

      .key-status {
          padding: 5px 15px;
          border-radius: 20px;
          font-size: 14px;
          font-weight: 500;
      }

      .status-active {
          background: #d1fae5;
          color: #065f46;
      }

      .status-expired {
          background: #fee2e2;
          color: #991b1b;
      }

      .key-info {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 10px;
          margin-bottom: 15px;
      }

      .key-info-item {
          display: flex;
          flex-direction: column;
      }

      .key-info-label {
          font-size: 12px;
          color: #666;
          margin-bottom: 3px;
      }

      .key-info-value {
          font-weight: 500;
          color: #333;
      }

      .key-actions {
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
      }

      .key-actions .btn {
          flex: 1;
          min-width: 120px;
          justify-content: center;
      }

      .account-info {
          background: white;
          border: 2px solid #667eea;
          border-radius: 10px;
          padding: 20px;
          margin-top: 15px;
      }

      .account-info-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 10px 0;
          border-bottom: 1px solid #e0e0e0;
      }

      .account-info-item:last-child {
          border-bottom: none;
      }

      .account-info-label {
          font-weight: 500;
          color: #666;
      }

      .account-info-value {
          font-family: 'Courier New', monospace;
          color: #333;
          display: flex;
          align-items: center;
          gap: 10px;
      }

      .copy-btn {
          padding: 5px 10px;
          font-size: 12px;
      }

      .empty-state {
          text-align: center;
          padding: 60px 20px;
          color: #666;
      }

      .empty-state-icon {
          font-size: 4em;
          margin-bottom: 20px;
          opacity: 0.3;
      }

      .empty-state h3 {
          margin-bottom: 10px;
          color: #333;
      }

      .loading {
          text-align: center;
          padding: 20px;
          color: #667eea;
      }

      .spinner {
          border: 3px solid #f3f3f3;
          border-top: 3px solid #667eea;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
          margin: 0 auto 10px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .hidden {
          display: none !important;
      }

      /* Rate limit warning */
      .rate-limit-warning {
          background: #fef3c7;
          border: 2px solid #f59e0b;
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 20px;
          display: flex;
          align-items: center;
          gap: 10px;
      }

      .rate-limit-warning.error {
          background: #fee2e2;
          border-color: #ef4444;
      }

      /* Captcha container */
      .captcha-container {
          background: #f8fafc;
          border: 2px solid #e0e0e0;
          border-radius: 8px;
          padding: 20px;
          margin: 20px 0;
          text-align: center;
      }

      .captcha-challenge {
          font-size: 24px;
          font-weight: bold;
          color: #333;
          background: white;
          padding: 15px 30px;
          border-radius: 8px;
          display: inline-block;
          margin: 15px 0;
          letter-spacing: 5px;
          user-select: none;
      }

      .security-badge {
          display: inline-flex;
          align-items: center;
          gap: 5px;
          background: #10b981;
          color: white;
          padding: 5px 12px;
          border-radius: 20px;
          font-size: 12px;
          margin-top: 10px;
      }

      @media (max-width: 768px) {
          .header h1 {
              font-size: 1.8em;
          }

          .card {
              padding: 20px;
          }

          .tabs {
              overflow-x: auto;
          }

          .dashboard-stats {
              grid-template-columns: 1fr;
          }

          .key-actions {
              flex-direction: column;
          }

          .key-actions .btn {
              width: 100%;
          }
      }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
          <h1>
              <span>üé¨</span>
              Netflix Warranty
              <span class="security-badge">üîí Secured</span>
          </h1>
          <p>H·ªá th·ªëng qu·∫£n l√Ω key Netflix t·ª± ƒë·ªông - B·∫£o m·∫≠t cao</p>
      </div>

      <div class="card">
          <div class="tabs">
              <button class="tab active" onclick="switchTab('register')">
                  üìù ƒêƒÉng k√Ω
              </button>
              <button class="tab" onclick="switchTab('login')">
                  üîê ƒêƒÉng nh·∫≠p
              </button>
              <button class="tab hidden" id="dashboardTab" onclick="switchTab('dashboard')">
                  üìä Dashboard
              </button>
          </div>

          <!-- Alert -->
          <div id="alert" class="alert"></div>

          <!-- Tab ƒêƒÉng k√Ω -->
          <div id="register" class="tab-content active">
              <h2 style="margin-bottom: 20px;">T·∫°o Token M·ªõi</h2>
              <p style="color: #666; margin-bottom: 20px;">
                  Click n√∫t b√™n d∆∞·ªõi ƒë·ªÉ t·∫°o token 30 k√Ω t·ª±. Token n√†y s·∫Ω ƒë∆∞·ª£c d√πng ƒë·ªÉ ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng.
              </p>
              
              <button class="btn btn-primary" id="generateTokenBtn" onclick="generateToken()" style="width: 100%; justify-content: center;">
                  üé≤ T·∫°o Token M·ªõi
              </button>

              <div id="tokenDisplay" class="token-display hidden">
                  <h3 style="margin-bottom: 10px;">‚úÖ Token c·ªßa b·∫°n:</h3>
                  <div class="token-value" id="generatedToken"></div>
                  <p style="color: #ef4444; margin-top: 15px; font-weight: 500;">
                      ‚ö†Ô∏è L∆ØU TOKEN N√ÄY L·∫†I! B·∫°n s·∫Ω c·∫ßn n√≥ ƒë·ªÉ ƒëƒÉng nh·∫≠p.
                  </p>
                  <button class="btn btn-secondary" onclick="copyToken()" style="margin-top: 15px;">
                      üìã Copy Token
                  </button>
              </div>
          </div>

          <!-- Tab ƒêƒÉng nh·∫≠p -->
          <div id="login" class="tab-content">
              <h2 style="margin-bottom: 20px;">ƒêƒÉng nh·∫≠p</h2>
              <p style="color: #666; margin-bottom: 20px;">
                  Nh·∫≠p token 30 k√Ω t·ª± c·ªßa b·∫°n ƒë·ªÉ ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng.
              </p>

              <!-- Rate limit warning -->
              <div id="loginRateLimitWarning" class="hidden"></div>

              <!-- Captcha (hi·ªán khi c·∫ßn) -->
              <div id="loginCaptcha" class="captcha-container hidden">
                  <h4>üîí X√°c th·ª±c b·∫£o m·∫≠t</h4>
                  <p style="color: #666; margin: 10px 0;">Vui l√≤ng nh·∫≠p m√£ b√™n d∆∞·ªõi:</p>
                  <div class="captcha-challenge" id="captchaChallenge"></div>
                  <div class="form-group">
                      <input type="text" id="captchaInput" placeholder="Nh·∫≠p m√£ x√°c th·ª±c" maxlength="6">
                  </div>
              </div>

              <div class="form-group">
                  <label for="loginToken">Token (30 k√Ω t·ª±)</label>
                  <input type="text" id="loginToken" placeholder="Nh·∫≠p token c·ªßa b·∫°n" maxlength="30">
              </div>

              <button class="btn btn-primary" id="loginBtn" onclick="login()" style="width: 100%; justify-content: center;">
                  üîì ƒêƒÉng nh·∫≠p
              </button>

              <div style="margin-top: 15px; text-align: center; color: #666; font-size: 14px;">
                  <span class="security-badge">üõ°Ô∏è Protected by Advanced Security</span>
              </div>
          </div>

          <!-- Tab Dashboard -->
          <div id="dashboard" class="tab-content">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                  <h2>Dashboard</h2>
                  <button class="btn btn-danger" onclick="logout()">
                      üö™ ƒêƒÉng xu·∫•t
                  </button>
              </div>

              <!-- Stats -->
              <div class="dashboard-stats">
                  <div class="stat-card">
                      <h3 id="totalKeys">0</h3>
                      <p>T·ªïng s·ªë key</p>
                  </div>
                  <div class="stat-card">
                      <h3 id="activeKeys">0</h3>
                      <p>Key ƒëang ho·∫°t ƒë·ªông</p>
                  </div>
                  <div class="stat-card">
                      <h3 id="accountsReceived">0</h3>
                      <p>T√†i kho·∫£n ƒë√£ nh·∫≠n</p>
                  </div>
              </div>

              <!-- K√≠ch ho·∫°t key m·ªõi -->
              <div style="background: #f8fafc; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                  <h3 style="margin-bottom: 15px;">K√≠ch ho·∫°t Key M·ªõi</h3>
                  <div style="display: flex; gap: 10px;">
                      <input type="text" id="newKey" placeholder="Nh·∫≠p m√£ key" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px;">
                      <button class="btn btn-success" id="activateKeyBtn" onclick="activateKey()">
                          ‚úÖ K√≠ch ho·∫°t
                      </button>
                  </div>
              </div>

              <!-- Danh s√°ch key -->
              <h3 style="margin-bottom: 20px;">Danh s√°ch Key c·ªßa b·∫°n</h3>
              <div id="keyList" class="key-list">
                  <div class="loading">
                      <div class="spinner"></div>
                      <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <script>
      const API_URL = 'http://localhost:5000';
      let currentToken = localStorage.getItem('token') || '';

      // ==================== SECURITY FEATURES ====================
      
      // 1. Rate Limiting (Client-side tracking)
      const RateLimiter = {
          attempts: {},
          
          // Ki·ªÉm tra rate limit
          check(action, maxAttempts = 5, windowMs = 60000) {
              const now = Date.now();
              const key = action;
              
              if (!this.attempts[key]) {
                  this.attempts[key] = [];
              }
              
              // X√≥a c√°c attempts c≈©
              this.attempts[key] = this.attempts[key].filter(time => now - time < windowMs);
              
              // Ki·ªÉm tra s·ªë l·∫ßn th·ª≠
              if (this.attempts[key].length >= maxAttempts) {
                  const oldestAttempt = Math.min(...this.attempts[key]);
                  const waitTime = Math.ceil((windowMs - (now - oldestAttempt)) / 1000);
                  return { allowed: false, waitTime };
              }
              
              return { allowed: true };
          },
          
          // Th√™m attempt
          add(action) {
              const now = Date.now();
              if (!this.attempts[action]) {
                  this.attempts[action] = [];
              }
              this.attempts[action].push(now);
          },
          
          // Reset
          reset(action) {
              this.attempts[action] = [];
          }
      };

      // 2. Fingerprinting (Device identification)
      const DeviceFingerprint = {
          async generate() {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              ctx.textBaseline = 'top';
              ctx.font = '14px Arial';
              ctx.fillText('fingerprint', 2, 2);
              const canvasData = canvas.toDataURL();
              
              const fingerprint = {
                  canvas: await this.hash(canvasData),
                  screen: `${screen.width}x${screen.height}x${screen.colorDepth}`,
                  timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                  language: navigator.language,
                  platform: navigator.platform,
                  userAgent: navigator.userAgent,
                  timestamp: Date.now()
              };
              
              return await this.hash(JSON.stringify(fingerprint));
          },
          
          async hash(str) {
              const buffer = new TextEncoder().encode(str);
              const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
              const hashArray = Array.from(new Uint8Array(hashBuffer));
              return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
          }
      };

      // 3. CAPTCHA Generator
      const CaptchaManager = {
          current: null,
          
          generate() {
              const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
              let captcha = '';
              for (let i = 0; i < 6; i++) {
                  captcha += chars.charAt(Math.floor(Math.random() * chars.length));
              }
              this.current = captcha;
              return captcha;
          },
          
          verify(input) {
              return input && this.current && input.toUpperCase() === this.current;
          },
          
          reset() {
              this.current = null;
          }
      };

      // 4. Request Signature
      async function signRequest(data) {
          const fingerprint = await DeviceFingerprint.generate();
          const timestamp = Date.now();
          const nonce = Math.random().toString(36).substring(7);
          
          return {
              ...data,
              _security: {
                  fingerprint,
                  timestamp,
                  nonce
              }
          };
      }

      // 5. Anti-automation detection
      const BehaviorAnalyzer = {
          mouseMovements: 0,
          keyPresses: 0,
          
          init() {
              document.addEventListener('mousemove', () => this.mouseMovements++);
              document.addEventListener('keypress', () => this.keyPresses++);
          },
          
          isHuman() {
              return this.mouseMovements > 5 || this.keyPresses > 3;
          }
      };

      // Initialize behavior analyzer
      BehaviorAnalyzer.init();

      // ==================== ENHANCED API CALLS ====================

      // Ki·ªÉm tra ƒëƒÉng nh·∫≠p khi load trang
      window.onload = function() {
          if (currentToken) {
              checkTokenAndLoadDashboard();
          }
      };

      // Chuy·ªÉn tab
      function switchTab(tabName) {
          document.querySelectorAll('.tab-content').forEach(tab => {
              tab.classList.remove('active');
          });

          document.querySelectorAll('.tab').forEach(tab => {
              tab.classList.remove('active');
          });

          document.getElementById(tabName).classList.add('active');
          event.target.classList.add('active');

          if (tabName === 'dashboard') {
              loadDashboard();
          }
      }

      // Hi·ªán th√¥ng b√°o
      function showAlert(message, type = 'info') {
          const alert = document.getElementById('alert');
          alert.className = `alert alert-${type} show`;
          alert.textContent = message;

          setTimeout(() => {
              alert.classList.remove('show');
          }, 5000);
      }

      // T·∫°o token v·ªõi rate limiting
      async function generateToken() {
          const btn = document.getElementById('generateTokenBtn');
          
          // Check rate limit
          const rateCheck = RateLimiter.check('generate_token', 3, 300000); // 3 l·∫ßn / 5 ph√∫t
          if (!rateCheck.allowed) {
              showAlert(`‚è≥ Vui l√≤ng ƒë·ª£i ${Math.ceil(rateCheck.waitTime / 60)} ph√∫t tr∆∞·ªõc khi t·∫°o token m·ªõi!`, 'warning');
              return;
          }

          // Check human behavior
          if (!BehaviorAnalyzer.isHuman()) {
              showAlert('‚ùå Ph√°t hi·ªán h√†nh vi b·∫•t th∆∞·ªùng. Vui l√≤ng th·ª≠ l·∫°i!', 'error');
              return;
          }

          btn.disabled = true;
          btn.textContent = '‚è≥ ƒêang t·∫°o...';

          try {
              const signedData = await signRequest({});
              
              const response = await fetch(`${API_URL}/api/auth/generate-token`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(signedData)
              });

              const data = await response.json();

              if (data.success) {
                  RateLimiter.add('generate_token');
                  document.getElementById('generatedToken').textContent = data.data.token;
                  document.getElementById('tokenDisplay').classList.remove('hidden');
                  showAlert('‚úÖ T·∫°o token th√†nh c√¥ng! H√£y l∆∞u token n√†y l·∫°i.', 'success');
              } else {
                  showAlert('‚ùå ' + data.message, 'error');
              }
          } catch (error) {
              showAlert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
          } finally {
              btn.disabled = false;
              btn.innerHTML = 'üé≤ T·∫°o Token M·ªõi';
          }
      }

      // Copy token
      function copyToken() {
          const token = document.getElementById('generatedToken').textContent;
          navigator.clipboard.writeText(token).then(() => {
              showAlert('‚úÖ ƒê√£ copy token v√†o clipboard!', 'success');
          });
      }

      // ƒêƒÉng nh·∫≠p v·ªõi b·∫£o m·∫≠t cao
      async function login() {
          const token = document.getElementById('loginToken').value.trim();
          const btn = document.getElementById('loginBtn');
          const warningDiv = document.getElementById('loginRateLimitWarning');

          if (!token) {
              showAlert('‚ùå Vui l√≤ng nh·∫≠p token!', 'error');
              return;
          }

          if (token.length !== 30) {
              showAlert('‚ùå Token ph·∫£i c√≥ ƒë√∫ng 30 k√Ω t·ª±!', 'error');
              return;
          }

          // Check rate limit - 5 l·∫ßn / ph√∫t
          const rateCheck = RateLimiter.check('login', 5, 60000);
          if (!rateCheck.allowed) {
              warningDiv.className = 'rate-limit-warning error';
              warningDiv.innerHTML = `‚ö†Ô∏è Qu√° nhi·ªÅu l·∫ßn ƒëƒÉng nh·∫≠p th·∫•t b·∫°i! Vui l√≤ng ƒë·ª£i ${rateCheck.waitTime} gi√¢y.`;
              warningDiv.classList.remove('hidden');
              return;
          }

          // Show captcha after 3 failed attempts
          const failedAttempts = RateLimiter.attempts['login'] ? RateLimiter.attempts['login'].length : 0;
          if (failedAttempts >= 3) {
              const captchaDiv = document.getElementById('loginCaptcha');
              if (captchaDiv.classList.contains('hidden')) {
                  const captcha = CaptchaManager.generate();
                  document.getElementById('captchaChallenge').textContent = captcha;
                  captchaDiv.classList.remove('hidden');
                  showAlert('üîí Vui l√≤ng ho√†n th√†nh x√°c th·ª±c b·∫£o m·∫≠t!', 'warning');
                  return;
              }

              const captchaInput = document.getElementById('captchaInput').value;
              if (!CaptchaManager.verify(captchaInput)) {
                  showAlert('‚ùå M√£ x√°c th·ª±c kh√¥ng ƒë√∫ng!', 'error');
                  const newCaptcha = CaptchaManager.generate();
                  document.getElementById('captchaChallenge').textContent = newCaptcha;
                  document.getElementById('captchaInput').value = '';
                  return;
              }
          }

          btn.disabled = true;
          btn.textContent = '‚è≥ ƒêang ƒëƒÉng nh·∫≠p...';

          try {
              const signedData = await signRequest({ token });
              
              const response = await fetch(`${API_URL}/api/auth/login`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(signedData)
              });

              const data = await response.json();

              if (data.success) {
                  currentToken = token;
                  localStorage.setItem('token', token);
                  
                  // Reset rate limiter on success
                  RateLimiter.reset('login');
                  CaptchaManager.reset();
                  document.getElementById('loginCaptcha').classList.add('hidden');
                  warningDiv.classList.add('hidden');
                  
                  showAlert('‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
                  
                  document.getElementById('dashboardTab').classList.remove('hidden');
                  
                  setTimeout(() => {
                      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                      document.getElementById('dashboard').classList.add('active');
                      document.getElementById('dashboardTab').classList.add('active');
                      loadDashboard();
                  }, 1000);
              } else {
                  RateLimiter.add('login');
                  showAlert('‚ùå ' + data.message, 'error');
                  
                  // Show warning after 2 failed attempts
                  if (RateLimiter.attempts['login'].length >= 2) {
                      warningDiv.className = 'rate-limit-warning';
                      warningDiv.innerHTML = `‚ö†Ô∏è C·∫£nh b√°o: ${RateLimiter.attempts['login'].length}/5 l·∫ßn th·ª≠. T√†i kho·∫£n s·∫Ω b·ªã kh√≥a t·∫°m th·ªùi sau 5 l·∫ßn th·∫•t b·∫°i.`;
                      warningDiv.classList.remove('hidden');
                  }
              }
          } catch (error) {
              showAlert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
          } finally {
              btn.disabled = false;
              btn.innerHTML = 'üîì ƒêƒÉng nh·∫≠p';
          }
      }

      // Ki·ªÉm tra token v√† load dashboard
      async function checkTokenAndLoadDashboard() {
          try {
              const response = await fetch(`${API_URL}/api/auth/profile`, {
                  headers: {
                      'Authorization': `Bearer ${currentToken}`
                  }
              });

              const data = await response.json();

              if (data.success) {
                  document.getElementById('dashboardTab').classList.remove('hidden');
                  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                  document.getElementById('dashboard').classList.add('active');
                  document.getElementById('dashboardTab').classList.add('active');
                  loadDashboard();
              } else {
                  localStorage.removeItem('token');
                  currentToken = '';
              }
          } catch (error) {
              console.error('Error checking token:', error);
          }
      }

      // Load dashboard
      async function loadDashboard() {
          try {
              const profileResponse = await fetch(`${API_URL}/api/auth/profile`, {
                  headers: {
                      'Authorization': `Bearer ${currentToken}`
                  }
              });

              const profileData = await profileResponse.json();

              if (!profileData.success) {
                  showAlert('‚ùå Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n!', 'error');
                  logout();
                  return;
              }

              const keysResponse = await fetch(`${API_URL}/api/key/list`, {
                  headers: {
                      'Authorization': `Bearer ${currentToken}`
                  }
              });

              const keysData = await keysResponse.json();

              if (keysData.success) {
                  displayKeys(keysData.data.keys);
                  updateStats(keysData.data.keys);
              } else {
                  showAlert('‚ùå ' + keysData.message, 'error');
              }
          } catch (error) {
              showAlert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
          }
      }

      // Hi·ªÉn th·ªã danh s√°ch key
      function displayKeys(keys) {
          const keyList = document.getElementById('keyList');

          if (keys.length === 0) {
              keyList.innerHTML = `
                  <div class="empty-state">
                      <div class="empty-state-icon">üîë</div>
                      <h3>Ch∆∞a c√≥ key n√†o</h3>
                      <p>Nh·∫≠p m√£ key ·ªü ph√≠a tr√™n ƒë·ªÉ k√≠ch ho·∫°t</p>
                  </div>
              `;
              return;
          }

          keyList.innerHTML = keys.map(key => `
              <div class="key-card" id="key-${key.key}">
                  <div class="key-header">
                      <div class="key-code">${key.key}</div>
                      <div class="key-status ${key.is_active ? 'status-active' : 'status-expired'}">
                          ${key.is_active ? '‚úÖ Ho·∫°t ƒë·ªông' : '‚ùå H·∫øt h·∫°n'}
                      </div>
                  </div>

                  <div class="key-info">
                      <div class="key-info-item">
                          <div class="key-info-label">Ng√†y k√≠ch ho·∫°t</div>
                          <div class="key-info-value">${key.activation_date || 'Ch∆∞a k√≠ch ho·∫°t'}</div>
                      </div>
                      <div class="key-info-item">
                          <div class="key-info-label">Ng√†y h·∫øt h·∫°n</div>
                          <div class="key-info-value">${key.expiry_date || 'N/A'}</div>
                      </div>
                      <div class="key-info-item">
                          <div class="key-info-label">Th·ªùi h·∫°n</div>
                          <div class="key-info-value">${key.duration_days || 0} ng√†y</div>
                      </div>
                      <div class="key-info-item">
                          <div class="key-info-label">Tr·∫°ng th√°i t√†i kho·∫£n</div>
                          <div class="key-info-value">${key.has_account ? '‚úÖ ƒê√£ nh·∫≠n' : '‚è≥ Ch∆∞a nh·∫≠n'}</div>
                      </div>
                  </div>

                  <div class="key-actions">
                      ${!key.has_account ? `
                          <button class="btn btn-success" onclick="getAccount('${key.key}')">
                              üéÅ Nh·∫≠n t√†i kho·∫£n
                          </button>
                      ` : `
                          <button class="btn btn-primary" onclick="viewAccount('${key.key}')">
                              üëÅÔ∏è Xem t√†i kho·∫£n
                          </button>
                          <button class="btn btn-warning" onclick="warranty('${key.key}')">
                              üîß B·∫£o h√†nh
                          </button>
                      `}
                  </div>

                  <div id="account-${key.key}" class="account-info hidden"></div>
              </div>
          `).join('');
      }

      // C·∫≠p nh·∫≠t th·ªëng k√™
      function updateStats(keys) {
          const total = keys.length;
          const active = keys.filter(k => k.is_active).length;
          const hasAccount = keys.filter(k => k.has_account).length;

          document.getElementById('totalKeys').textContent = total;
          document.getElementById('activeKeys').textContent = active;
          document.getElementById('accountsReceived').textContent = hasAccount;
      }

      // K√≠ch ho·∫°t key v·ªõi rate limiting
      async function activateKey() {
          const key = document.getElementById('newKey').value.trim();
          const btn = document.getElementById('activateKeyBtn');

          if (!key) {
              showAlert('‚ùå Vui l√≤ng nh·∫≠p m√£ key!', 'error');
              return;
          }

          // Rate limit: 10 l·∫ßn / ph√∫t
          const rateCheck = RateLimiter.check('activate_key', 10, 60000);
          if (!rateCheck.allowed) {
              showAlert(`‚è≥ Vui l√≤ng ƒë·ª£i ${rateCheck.waitTime} gi√¢y!`, 'warning');
              return;
          }

          btn.disabled = true;
          btn.textContent = '‚è≥ ƒêang k√≠ch ho·∫°t...';

          try {
              const signedData = await signRequest({ key });
              
              const response = await fetch(`${API_URL}/api/key/activate`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${currentToken}`
                  },
                  body: JSON.stringify(signedData)
              });

              const data = await response.json();

              if (data.success) {
                  RateLimiter.add('activate_key');
                  showAlert('‚úÖ K√≠ch ho·∫°t key th√†nh c√¥ng!', 'success');
                  document.getElementById('newKey').value = '';
                  loadDashboard();
              } else {
                  showAlert('‚ùå ' + data.message, 'error');
              }
          } catch (error) {
              showAlert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
          } finally {
              btn.disabled = false;
              btn.innerHTML = '‚úÖ K√≠ch ho·∫°t';
          }
      }

      // Nh·∫≠n t√†i kho·∫£n
      async function getAccount(key) {
          if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën nh·∫≠n t√†i kho·∫£n Netflix cho key n√†y?')) {
              return;
          }

          try {
              const response = await fetch(`${API_URL}/api/account/get/${key}`, {
                  method: 'POST',
                  headers: {
                      'Authorization': `Bearer ${currentToken}`
                  }
              });

              const data = await response.json();

              if (data.success) {
                  showAlert('‚úÖ Nh·∫≠n t√†i kho·∫£n th√†nh c√¥ng!', 'success');
                  loadDashboard();
              } else {
                  showAlert('‚ùå ' + data.message, 'error');
              }
          } catch (error) {
              showAlert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
          }
      }

      // Xem t√†i kho·∫£n
      async function viewAccount(key) {
          const accountDiv = document.getElementById(`account-${key}`);

          if (!accountDiv.classList.contains('hidden')) {
              accountDiv.classList.add('hidden');
              return;
          }

          try {
              const response = await fetch(`${API_URL}/api/account/info/${key}`, {
                  headers: {
                      'Authorization': `Bearer ${currentToken}`
                  }
              });

              const data = await response.json();

              if (data.success) {
                  const account = data.data;
                  accountDiv.innerHTML = `
                      <h4 style="margin-bottom: 15px;">Th√¥ng tin t√†i kho·∫£n Netflix</h4>
                      <div class="account-info-item">
                          <span class="account-info-label">Email:</span>
                          <span class="account-info-value">
                              ${account.email}
                              <button class="btn btn-secondary copy-btn" onclick="copyText('${account.email}')">üìã Copy</button>
                          </span>
                      </div>
                      <div class="account-info-item">
                          <span class="account-info-label">Password:</span>
                          <span class="account-info-value">
                              ${account.password}
                              <button class="btn btn-secondary copy-btn" onclick="copyText('${account.password}')">üìã Copy</button>
                          </span>
                      </div>
                      <div class="account-info-item">
                          <span class="account-info-label">Cookie:</span>
                          <span class="account-info-value">
                              <button class="btn btn-secondary copy-btn" onclick="getCookie('${key}')">üìã Copy Cookie</button>
                          </span>
                      </div>
                  `;
                  accountDiv.classList.remove('hidden');
              } else {
                  showAlert('‚ùå ' + data.message, 'error');
              }
          } catch (error) {
              showAlert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
          }
      }

      // B·∫£o h√†nh
      async function warranty(key) {
          if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën b·∫£o h√†nh t√†i kho·∫£n n√†y? H·ªá th·ªëng s·∫Ω ki·ªÉm tra v√† c·∫•p t√†i kho·∫£n m·ªõi n·∫øu c·∫ßn.')) {
              return;
          }

          showAlert('‚è≥ ƒêang ki·ªÉm tra t√†i kho·∫£n...', 'info');

          try {
              const response = await fetch(`${API_URL}/api/account/warranty/${key}`, {
                  method: 'POST',
                  headers: {
                      'Authorization': `Bearer ${currentToken}`
                  }
              });

              const data = await response.json();

              if (data.success) {
                  showAlert('‚úÖ ' + data.message, 'success');
                  loadDashboard();
              } else {
                  showAlert('‚ùå ' + data.message, 'error');
              }
          } catch (error) {
              showAlert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
          }
      }

      // Copy text
      function copyText(text) {
          navigator.clipboard.writeText(text).then(() => {
              showAlert('‚úÖ ƒê√£ copy v√†o clipboard!', 'success');
          });
      }

      // Get cookie
      async function getCookie(key) {
          try {
              const response = await fetch(`${API_URL}/api/account/cookie/${key}`, {
                  headers: {
                      'Authorization': `Bearer ${currentToken}`
                  }
              });

              const data = await response.json();

              if (data.success) {
                  navigator.clipboard.writeText(data.data.cookie).then(() => {
                      showAlert('‚úÖ ƒê√£ copy cookie v√†o clipboard!', 'success');
                  });
              } else {
                  showAlert('‚ùå ' + data.message, 'error');
              }
          } catch (error) {
              showAlert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
          }
      }

      // ƒêƒÉng xu·∫•t
      function logout() {
          if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
              localStorage.removeItem('token');
              currentToken = '';
              
              document.getElementById('dashboardTab').classList.add('hidden');
              document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
              document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
              document.getElementById('login').classList.add('active');
              document.querySelector('.tab').classList.add('active');
              
              showAlert('‚úÖ ƒê√£ ƒëƒÉng xu·∫•t!', 'success');
          }
      }
  </script>
</body>
</html>
